---
title: "Investigating size at planting/first survey"
author: 'eleanorjackson'
date: '`r format(Sys.time(), "%d %B, %Y")`' 
format: gfm+emoji
editor: source
execute:
  warning: false
---

```{r setup}
#| include: false

file_name <- knitr::current_input()

knitr::opts_chunk$set(
  fig.path =
    paste0("figures/", sub("\\.rmarkdown$", "", basename(file_name)), "/", sep = "")
)

ggplot2::theme_set(ggplot2::theme_classic(base_size = 10))
```

> Seedlings were not planted in the forest types at the same time,
> the secondary forest of SBE was planted first 
> then the left over seedlings in the nursery were planted in the 
> primary old growth forest of Danum Valley Conservation Area. Meaning… 
> seedlings grow for a different amount of time in the two forest types 
> and initial size is not equalized by randomization 
> (appears to differ on a species-by-species basis if I recall correctly)

Smaller seedlings usually have a faster rate of growth, 
which slows as they get larger.

Taking a look at this now that I've combined the different data sources
and done a little simple cleaning.
(see [00_combine-raw-data.R](code/scripts/00_combine-raw-data.R) and [01_clean-data.R](code/scripts/01_clean-data.R)).

```{r packages}
#| output: false

library("tidyverse")
library("here")
library("patchwork")
```

```{r}
data <- 
  readRDS(here::here("data", "derived", "data_cleaned.rds"))
```

Let's have a quick look at the timeline of surveys.

```{r}
#| fig-height: 3
#| fig-width: 7

data %>% 
  group_by(forest_type, survey_date) %>% 
  slice_head() %>% 
  ggplot(aes(y = forest_type, x = survey_date)) +
  geom_point(alpha = 0.6, shape = 16, size = 3)
```

We are waiting on the latest data (2024) from the SBE. 
__Do we have planting dates for the Danum Valley seedlings?__

## Starting size

Find the first survey date for each individual.

```{r}
data <- 
  data %>% 
  group_by(plant_id) %>%
  slice_min(survey_date, with_ties = FALSE) %>%
  ungroup() %>% 
  select(plant_id, survey_date) %>%
  rename(first_survey = survey_date) %>% 
  right_join(data) 
```

```{r}
data %>% 
  filter(survey_date == first_survey) %>% 
  summarise_at(c("dbase_mean", "dbh_mean"), 
               ~sum(is.na(.x))
               )
```

There are a lot of entries with a record for survival but no diameter measurement.
__Why would survival be recorded without a diameter measurement?__

```{r}
data %>% 
  filter(survey_date == first_survey) %>% 
  filter(is.na(dbase_mean) & is.na(dbh_mean)) %>% 
  group_by(forest_type) %>% 
  summarise(n())
```

This is mostly happening in the SBE data. 

Find the first survey without size NAs instead.

```{r}
data <- 
  data %>% 
  select(- first_survey) %>% 
  drop_na(dbase_mean) %>% 
  group_by(plant_id) %>%
  slice_min(survey_date, with_ties = FALSE) %>%
  ungroup() %>% 
  select(plant_id, survey_date) %>%
  rename(first_survey = survey_date) %>% 
  right_join(select(data, - first_survey)) 
```


```{r}
data %>% 
  filter(survey_date == first_survey) %>% 
  ggplot(aes(x = dbase_mean)) +
  geom_histogram(binwidth = 2) +
  facet_wrap(~forest_type, scales = "free_y") +
  xlim(0, 50) +
  
  data %>% 
  filter(survey_date == first_survey) %>% 
  ggplot(aes(x = dbh_mean)) +
  geom_histogram(binwidth = 2) +
  facet_wrap(~forest_type, scales = "free_y") +
  xlim(0, 50) +
  
  data %>% 
  filter(survey_date == first_survey) %>% 
  ggplot(aes(x = height_apex)) +
  geom_histogram(binwidth = 5) +
  facet_wrap(~forest_type, scales = "free_y") +
  xlim(0, 500) +
  
  plot_layout(ncol = 1)
```

Looks like it's going to be best to look at basal diameter. 
__Is there a way to estimate DBH from basal diameter or vice versa?__

## Starting size ~ species + forest type

```{r}
data %>% 
  filter(survey_date == first_survey) %>% 
  ggplot(aes(x = dbase_mean, 
             fill = forest_type,
             colour = forest_type)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~genus_species) +
  stat_summary(aes(xintercept = ..x.., y = 0), 
               fun = mean, 
               geom = "vline", 
               orientation = "y",
               linetype = 2) +
  xlim(0, 20) +
  ggtitle("Size at first survey")
```

The primary forest (Danum) seedlings often have a greater spread of sizes and a larger mean size in their first survey. They were planted later, but were larger at the time of planting.

But some species have pretty good overlap:
 
- _S. gibbosa_
- _S. macroptera_
- _S. faguetiana_

I've forgotten that there are two cohorts of primary forest seedlings,
perhaps that's why they have a wider distribution of sizes.

```{r}
data %>% 
  filter(
    forest_type == "primary" & 
      survey_date == first_survey &
      !is.na(old_new)) %>% 
  ggplot(aes(x = dbase_mean, 
             fill = forest_type,
             colour = forest_type,
             linetype = old_new)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~genus_species) +
  stat_summary(aes(xintercept = ..x.., y = 0), 
               fun = mean, 
               geom = "vline", 
               orientation = "y") +
  xlim(0, 20) 
```

Very similar for most species.

Now comparing all three groups: secondary forest, primary forest first cohort
& primary forest second cohort.

```{r}
data %>% 
  rowwise() %>% 
  mutate(type = paste(forest_type, old_new, sep = "_")) %>% 
  ungroup() %>% 
  filter(survey_date == first_survey) %>% 
  filter(case_when(
    forest_type == "primary" ~ !is.na(old_new),
    T ~ is.na(old_new)
  )) %>% 
  ggplot(aes(x = dbase_mean, 
             fill = type,
             colour = type)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~genus_species) +
  stat_summary(aes(xintercept = ..x.., y = 0), 
               fun = mean, 
               geom = "vline", 
               orientation = "y",
               linetype = 2) +
  xlim(0, 20) 
```

The old and new secondary cohorts seem very close to each other 
compared to the primary forest seedlings.

Biggest differences in old v new seen for 
_H. sangal, S. beccariana, S. faguetiana, S. macrophylla._

## Growth ~ species + forest type

Now let’s see if growth is different over time for these three groups.

```{r}
data %>%
  rowwise() %>% 
  mutate(type = paste(forest_type, old_new, sep = "_")) %>% 
  ungroup() %>% 
  filter(type != "primary_NA") %>% 
  ggplot(aes(y = log(dbase_mean),
             x = survey_date,
             fill = type,
             colour = type)) +
  geom_smooth(alpha = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  facet_wrap(~genus_species) +
  scale_x_date(guide = guide_axis(angle = 90)) 
```

For most species, the seedlings have similar patterns of growth - parallel lines.

Making that plot again but using `days_since_first_survey` on 
the y-axis, rather than `survey_date`.

```{r}
data <-
  data %>% 
  drop_na(dbase_mean) %>%
  rowwise() %>% 
  mutate(
    days_since_first_survey =
      survey_date - first_survey
  ) %>% 
  ungroup()
```


```{r}
data %>%
  rowwise() %>% 
  mutate(type = paste(forest_type, old_new, sep = "_")) %>% 
  ungroup() %>% 
  filter(type != "primary_NA") %>% 
  ggplot(aes(y = log(dbase_mean),
             x = days_since_first_survey,
             fill = type,
             colour = type)) +
  geom_smooth(alpha = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  facet_wrap(~genus_species, scales = "free_y")
```

Now adding in data points.

```{r}
data %>%
  rowwise() %>% 
  mutate(type = paste(forest_type, old_new, sep = "_")) %>% 
  ungroup() %>% 
  filter(type != "primary_NA") %>% 
  drop_na(dbase_mean) %>% 
  ggplot(aes(y = log(dbase_mean),
             x = days_since_first_survey,
             fill = type,
             colour = type)) +
  geom_point(shape = 16, size = 0.5, alpha = 0.3) +
  geom_smooth(alpha = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  facet_wrap(~genus_species, scales = "free_y") 
```

I want to look at a few of the species more closely.

```{r}
data %>%
  rowwise() %>% 
  mutate(type = paste(forest_type, old_new, sep = "_")) %>% 
  ungroup() %>% 
  drop_na(dbase_mean) %>% 
  filter(type != "primary_NA" &
           (genus_species == "Shorea_macrophylla" |
           genus_species == "Shorea_johorensis")) %>% 
  ggplot(aes(y = log(dbase_mean),
             x = days_since_first_survey,
             fill = type,
             colour = type)) +
  geom_point(shape = 16, size = 1, alpha = 0.3) +
  geom_smooth(alpha = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  facet_wrap(~genus_species, scales = "free_y") +
  theme(legend.position = "top") 

```

## Individual growth ~ starting size

New column for size at first survey.

```{r}
data <- 
  data %>%
  filter(survey_date == first_survey) %>% 
  rename(start_size = dbase_mean) %>% 
  select(plant_id, start_size) %>% 
  distinct() %>% 
  right_join(data)
```

```{r}
data %>% 
  drop_na(dbase_mean, start_size) %>% 
  filter(start_size < 10) %>% 
  ggplot(aes(y = log(dbase_mean),
             x = days_since_first_survey,
             group = start_size,
             colour = start_size)) +
  geom_smooth(alpha = 0.3, se = FALSE, linewidth = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  scale_colour_viridis_c() +
  facet_wrap(~genus_species)
```

Steeper purple lines compared to yellow lines would mean that
smaller seedlings have a faster rate of growth. 
Maybe some evidence of this in _Shorea argentifolia._

Let's separate out secondary and primary forest seedlings.

```{r}
#| fig-height: 10
#| fig-width: 7

data %>% 
  filter(forest_type == "primary") %>% 
  drop_na(dbase_mean, start_size) %>% 
  filter(start_size < 10) %>% 
  ggplot(aes(y = log(dbase_mean),
             x = days_since_first_survey,
             group = start_size,
             colour = start_size)) +
  geom_smooth(alpha = 0.3, se = FALSE, linewidth = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  scale_colour_viridis_c() +
  facet_wrap(~genus_species) +
  ggtitle("Primary forest") +
  
  data %>% 
  filter(forest_type == "secondary") %>% 
  drop_na(dbase_mean, start_size) %>% 
  filter(start_size < 10) %>% 
  ggplot(aes(y = log(dbase_mean),
             x = days_since_first_survey,
             group = start_size,
             colour = start_size)) +
  geom_smooth(alpha = 0.3, se = FALSE, linewidth = 0.3,
              method = "glm", method.args = list(family = "gaussian")) +
  scale_colour_viridis_c() +
  facet_wrap(~genus_species) +
  ggtitle("Secondary forest") +
  
  plot_layout(ncol = 1, guides = "collect")
```

Is rate of growth faster for smaller seedlings?

Let's look at the initial rate of growth - from the first survey to
the last one before the break in data collection around 2008.

Growth rate =

size at time 1 - size at time 2 / (difference in days / 365.25)

```{r}
# get last survey date pre 2008
data <- 
  data %>% 
  drop_na(dbase_mean) %>%
  filter(survey_date < "2008-01-01") %>% 
  filter(survey_date != first_survey) %>% 
  group_by(plant_id) %>%
  slice_max(survey_date, with_ties = FALSE) %>%
  ungroup() %>% 
  select(plant_id, survey_date) %>%
  rename(yr3_survey = survey_date) %>% 
  right_join(data) 

# get size at that date
data <- 
  data %>%
  drop_na(dbase_mean) %>%
  filter(survey_date == yr3_survey) %>% 
  rename(yr3_size = dbase_mean) %>% 
  select(plant_id, yr3_size) %>% 
  distinct() %>% 
  right_join(data)

# calculate initial growth rate
data <- 
  data %>%
  drop_na(dbase_mean) %>%
  filter(old_new == "O" | is.na(old_new))%>% 
  filter(survey_date == first_survey |
           survey_date == yr3_survey) %>% 
  pivot_longer(cols = c(start_size, yr3_size)) %>% 
  group_by(plant_id) %>%
  summarise(growth = max(value) - min(value),
            time = max(days_since_first_survey)) %>% 
  mutate(time = time_length(time, unit = "days")) %>% 
  filter(time > 0) %>% 
  mutate(growth_rate_initial = growth / (time / 365.25) ) %>% 
  select(plant_id, growth_rate_initial) %>% 
  right_join(data)
    
```


```{r}
data %>% 
  drop_na(growth_rate_initial) %>% 
  filter(survey_date == first_survey) %>% 
  ggplot(aes(y = growth_rate_initial, 
             x = start_size,
             colour = forest_type)) +
  geom_point(shape = 16, alpha = 0.5)+
  geom_smooth(method = "glm", method.args = list(family = "gaussian"))
```

```{r}
data %>% 
  drop_na(growth_rate_initial) %>% 
  filter(survey_date == yr3_survey) %>% 
  ggplot(aes(y = growth_rate_initial, 
             x = start_size,
             colour = days_since_first_survey)) +
  geom_point(shape = 16, alpha = 0.5) +
  scale_colour_viridis_c()
```

```{r}
data %>% 
  drop_na(growth_rate_initial) %>% 
  filter(survey_date == first_survey) %>% 
  ggplot(aes(y = growth_rate_initial, 
             x = start_size,
             colour = forest_type)) +
  geom_point(shape = 16, alpha = 0.5, size = 1) +
  geom_smooth(se = FALSE,
              method = "glm", method.args = list(family = "gaussian")) +
  facet_wrap(~genus_species)
```
