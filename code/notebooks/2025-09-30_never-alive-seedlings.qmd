---
title: "Analysis of seedlings which were never recorded as alive"
author: 'eleanorjackson'
date: '`r format(Sys.time(), "%d %B, %Y")`' 
format: 
  gfm:
    toc: true
editor: source
execute:
  warning: false
---

```{r setup}
#| include: false

file_name <- knitr::current_input()

knitr::opts_chunk$set(
  fig.path =
    paste0("figures/", sub("\\.rmarkdown$", "", basename(file_name)), 
           "/", sep = "")
)

set.seed(123)
ggplot2::theme_set(ggplot2::theme_bw(base_size = 13))
```

57% of individuals were never recorded as alive (5,869 out of 10,274), 
i.e. they died in the period between planting and the first census.
We excluded these individuals from any further analysis since their mortality 
is likely due to stress from transplanting rather than any effect of forest type.
This only occurs in the logged forest because in the SBE seedlings were not 
censused on the day they were planted.

```{r}
library("tidyverse")
library("tidybayes")
library("brms")
library("patchwork")
library("ggtext")
library("modelr")
library("ggdist")
```

```{r}
left_censored <-
  readRDS(here::here("data", "derived", "data_cleaned.rds")) %>%
  filter(forest_type == "logged") %>% 
  group_by(plant_id) %>%
  summarise(n = sum(survival)) %>%
  filter(n == 0) %>%
  select(plant_id)

all <-
  readRDS(here::here("data", "derived", "data_cleaned.rds")) %>%
  filter(forest_type == "logged") %>% 
  distinct(plant_id)

# all 
nrow(distinct(
  readRDS(here::here("data", "derived", "data_cleaned.rds")), 
  plant_id))

# all logged
nrow(all)

# all logged left censored
nrow(left_censored)
```

Seedlings that were never recorded alive, when were they first censused?

```{r}
never_alive <-
  readRDS(here::here("data", "derived", "data_cleaned.rds")) %>%
  filter(plant_id %in% left_censored$plant_id)

never_alive %>% 
  filter(forest_type == "logged") %>% 
  filter(first_survey == survey_date ) %>% 
  group_by(census_no, cohort) %>% 
  summarise(n())
```

# First cohort

```{r}
data <-
  readRDS(here::here("data", "derived", "data_cleaned.rds")) %>% 
  filter(forest_type == "logged", cohort == "1") %>% 
  filter(census_no == "01")
```

```{r}
data %>% 
  group_by(survival) %>% 
  summarise(n())
```

## Fit model

```{r}
model_01 <- 
  brm(formula = survival ~ 0 + genus_species,
    data = data,
    family = bernoulli,
    prior = prior(normal(0, 2)),
    sample_prior = "yes",
    file_refit = "on_change",
    file = here::here("code",
                      "notebooks",
                      "models",
                      "2025-09-30_never-alive-seedlings",
                      "census-01-bernoulli-survival")
    )
```

```{r}
model_01
```

## Check prior

```{r}
prior_draws <- 
  prior_draws(model_01) %>% 
  select(contains("b"))

post_draws <- 
  as_draws_df(model_01, variable = "^b_", regex = TRUE)

prior_post <- 
  bind_rows(prior = prior_draws, 
            posterior = post_draws,
            .id = "dist") %>% 
  pivot_longer(cols = contains("b")) 
```

```{r}
#| fig-height: 6
#| fig-width: 5

prior_post %>% 
  mutate(dist = str_to_sentence(dist)) %>%
  mutate(dist = factor(dist, levels = c("Prior", "Posterior"))) %>%
  ggplot(aes(x = value, fill = dist, group = name)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~dist, scales = "free_y", ncol = 1) +
  theme(legend.title = element_blank())
```

## Make figure of posterior

```{r}
p1 <- 
  data %>% 
  modelr::data_grid(genus_species = unique(data$genus_species)) %>%
  tidybayes::add_epred_draws(object = model_01) %>% 
  mutate(genus_species = str_replace(genus_species, "_", " ")) %>%
  mutate(genus_species = paste0("<i>", genus_species, "</i>", sep = "")) %>%
  ggplot(aes(x = .epred, y = genus_species)) +
  ggdist::stat_halfeye(alpha = 0.7) +
  theme(axis.text.y = element_markdown()) +
  labs(x = "Estimate",
       y = "") +
  geom_vline(xintercept = 0.5, colour = "red", linetype = 2) +
  ggtitle("Cohort one")

p1
```

# Repeat for the second cohort 

```{r}
data_2 <-
  readRDS(here::here("data", "derived", "data_cleaned.rds")) %>% 
  filter(forest_type == "logged", cohort == "2") %>% 
  filter(census_no == "06")
```

```{r}
data_2 %>% 
  group_by(survival) %>% 
  summarise(n())
```


## Fit model

```{r}
model_02 <- 
  brm(formula = survival ~ 0 + genus_species,
    data = data_2,
    family = bernoulli,
    prior = prior(normal(0, 2)),
    sample_prior = "yes",
    file_refit = "on_change",
    file = here::here("code",
                      "notebooks",
                      "models",
                      "2025-09-30_never-alive-seedlings",
                      "census-06-bernoulli-survival")
    )
```

```{r}
model_02
```

## Make figure 

```{r}
p2 <- 
  data_2 %>% 
  modelr::data_grid(genus_species = fct_drop(unique(data_2$genus_species))) %>%
  tidybayes::add_epred_draws(object = model_02) %>% 
  mutate(genus_species = str_replace(genus_species, "_", " ")) %>%
  mutate(genus_species = paste0("<i>", genus_species, "</i>", sep = "")) %>%
  ggplot(aes(x = .epred, y = genus_species)) +
  ggdist::stat_halfeye(alpha = 0.7) +
  theme(axis.text.y = element_markdown()) +
  labs(x = "Estimate",
       y = "") +
  geom_vline(xintercept = 0.5, colour = "red", linetype = 2) +
  ggtitle("Cohort two")

p2
```

# Combine figures

```{r}
out_1 <- 
  data %>% 
  modelr::data_grid(genus_species = unique(data$genus_species)) %>%
  tidybayes::add_epred_draws(object = model_01) %>% 
  mutate(genus_species = str_replace(genus_species, "_", " ")) %>%
  mutate(genus_species = paste0("<i>", genus_species, "</i>", sep = ""))%>% 
  mutate(cohort = "Cohort one")

out_2 <-
  data_2 %>% 
  modelr::data_grid(genus_species = fct_drop(unique(data_2$genus_species))) %>%
  tidybayes::add_epred_draws(object = model_02) %>% 
  mutate(genus_species = str_replace(genus_species, "_", " ")) %>%
  mutate(genus_species = paste0("<i>", genus_species, "</i>", sep = "")) %>% 
  mutate(cohort = "Cohort two")

bind_rows(out_1, out_2) %>% 
  ggplot(aes(x = .epred, y = genus_species)) +
  ggdist::stat_halfeye(alpha = 0.7) +
  theme(axis.text.y = element_markdown()) +
  labs(x = "Estimate",
       y = "") +
  geom_vline(xintercept = 0.5, colour = "red", linetype = 2) +
  facet_wrap(~cohort)
  
```

# Do the estimates correlate?

```{r}

bind_rows(out_1, out_2) %>% 
  mutate(genus_species = 
           str_remove_all(genus_species, "</?[iI]>")) %>% 
  mutate(genus_species = 
           str_replace(genus_species, "^(\\S)\\S+\\s+", "\\1. ")) %>% 
  group_by(genus_species, cohort) %>% 
  ggdist::point_interval() %>% 
  pivot_wider(names_from = cohort, 
              values_from = .epred, 
              id_cols = genus_species) %>% 
  ggplot(aes(x = `Cohort two`, y = `Cohort one`)) +
  geom_point() +
  geom_text(aes(label = genus_species), 
            hjust = 0, nudge_x = 0.005,
            fontface = "italic") +
  expand_limits(x = c(0.5, 0.9))
```

